# 实现独立的订单簿数据采集系统（修正版）

## 需求分析
- 创建完全独立的数据采集系统，不依赖Flask架构
- 按秒采集数据，当最近3个档位区间有超过阈值时进行数据收集
- 特征包括订单簿挂单量、价差、挂单比例、波动率、K线主动买卖差值等
- 预测目标为未来5分钟的涨跌，使用现货价格和时间戳匹配
- 存储格式使用Parquet，数据量达到1-10万条用于训练

## 实现计划

### 1. 项目结构设计
- 创建独立的`data_collector`文件夹
- 内部结构：
  - `config.py`：配置文件，包含阈值设置和WebSocket URL
  - `websocket_client.py`：WebSocket客户端，负责数据采集
  - `feature_calculator.py`：特征计算模块
  - `label_generator.py`：标签生成模块
  - `data_storage.py`：数据存储模块
  - `main.py`：主程序入口
  - `requirements.txt`：依赖包管理

### 2. 数据采集模块
- 实现WebSocket客户端：
  - 订阅订单簿数据（depth@100ms）
  - 订阅K线数据（1m K线，binance API标准）
  - 订阅实时价格数据（ticker）
- 实现数据缓存：
  - 内存缓存订单簿数据
  - 内存缓存K线数据
  - 内存缓存价格数据和时间戳

### 3. 特征计算模块
- 实现订单簿特征计算：
  - 现货与合约市场3个档位买卖挂单各5个区间的挂单量（60个特征）
  - 3个档位上的挂单量比例
- 实现价差计算：现货和合约价差
- 实现波动率计算：近20期波动中位数（基于价格数据）
- 实现K线特征计算：
  - 上一根1分钟K主动买卖交易量差值
  - 当前K主动买卖交易量差值

### 4. 标签生成模块
- 实现基于时间戳的标签生成：
  - 采集数据时记录时间戳
  - 维护待标签数据缓冲区
  - 当检测到当前时间戳与缓冲区中数据的时间戳相差正好5分钟时：
    - 使用当前现货价格计算涨跌
    - 更新对应数据的标签
    - 将已标记的数据写入Parquet文件
- 实现涨跌判断：
  - 计算5分钟价格变化百分比
  - 设定合理的涨跌阈值，生成分类标签

### 5. 数据存储模块
- 实现Parquet格式存储：
  - 列式存储，支持高效压缩和查询
  - 按日期/小时分区，便于后续数据管理
  - 批量写入机制，提高存储效率
- 实现数据质量控制：
  - 处理数据缺失和异常值
  - 验证标签生成的准确性

### 6. 主程序模块
- 实现系统初始化：
  - 加载配置
  - 启动WebSocket连接
  - 初始化数据存储
- 实现数据采集循环：
  - 按秒检查阈值
  - 触发数据收集
  - 计算特征
  - 缓存待标签数据
  - 检查时间戳匹配，生成并更新标签
  - 将已标记数据写入存储
- 实现系统监控：
  - 日志记录
  - 错误处理
  - 性能监控

### 7. 依赖管理
- 列出必要的依赖包：
  - `websockets`：WebSocket客户端
  - `pandas`：数据处理
  - `pyarrow`：Parquet存储
  - `numpy`：数值计算
  - `python-dotenv`：环境变量管理

### 8. 测试与验证
- 实现单元测试：
  - 测试WebSocket连接
  - 测试特征计算
  - 测试标签生成逻辑
  - 测试数据存储
- 实现集成测试：
  - 测试完整的数据采集流程
  - 验证数据质量
  - 确保系统稳定运行

## 技术要点
- 使用异步编程确保数据采集的实时性
- 实现基于时间戳的标签匹配机制
- 使用Parquet格式存储数据，提高存储和查询效率
- 确保所有代码都在独立文件夹内，不依赖外部代码
- 优化系统性能，避免资源浪费

## 预期成果
- 完整的独立数据采集系统，能够按秒采集订单簿数据
- 结构化的Parquet数据集，包含所有必要的特征和正确的标签
- 为后续的机器学习模型训练做好准备
- 系统能够稳定运行，持续收集数据直到达到训练所需的数据量